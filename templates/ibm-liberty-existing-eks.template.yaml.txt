AWSTemplateFormatVersion: "2010-09-09"
Description: "Deploys WebSphere Liberty Operator and application into an existing EKS cluster"
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: EKS Configuration
        Parameters:
          - EKSClusterName
          - LaunchType
          - RoleName
      - Label:
          default: Application Configuration
        Parameters:
          - DeployApp
          - AppContainerImageURL
          - AppName
          - AppNamespace
          - AppReplicas
      - Label:
          default: License
        Parameters:
          - AcceptLicense
          - LicenseType
          - LicenseEdition
          - LicenseProductEntitlementSource
          - LicenseMetric
      - Label:
          default: Install Configuration
        Parameters:
          - S3BucketNameForLogs
      - Label:
          default: Dev Only Configuration
        Parameters:
          - S3FolderForCode
          - S3FolderForCodeHTTPSURL
    ParameterLabels:
      AcceptLicense:
        default: Accept*
      AppContainerImageURL:
        default: Application container image URL
      AppName:
        default: Application name
      AppNamespace:
        default: EKS Namespace to deploy the app
      AppReplicas:
        default: Number of app replicas
      DeployApp:
        default: Deploy Application
      EKSClusterName:
        default: EKS Cluster name*
      LaunchType:
        default: Launch type*
      LicenseEdition:
        default: Edition
      LicenseMetric:
        default: Metric
      LicenseProductEntitlementSource:
        default: Product Entitlement Source
      LicenseType:
        default: License type*
      RoleName:
        default: Role name*
      S3BucketNameForLogs:
        default: AWS S3 bucket name
      S3FolderForCode:
        default: S3 URL for code(Dev only)
      S3FolderForCodeHTTPSURL:
        default: S3 folder HTTPS URL for the code (Dev only)
Parameters:
  AcceptLicense:
    Type: String
    AllowedValues: [True, False ]
    Default: False
    Description: >-
      I accept the terms on the license agreement corresponding to the verson of IBM Program
      in the application container by setting this value to True. See https://ibm.biz/was-license 
      for the license agreement applicable to this IBM Program. You must accept the license for the installation to work.
  AppContainerImageURL:
    Type: String
    Default: "icr.io/appcafe/open-liberty/samples/getting-started"
    Description: URL of the application container image (defaults to Getting-Started sample application).
  AppName:
    Type: String
    Default: "websphereliberty-app-sample"
    Description: Application Name.
  AppNamespace:
    Type: String
    Default: "default"
    Description: Namespace in the EKS cluster where app will be deployed.
  AppReplicas:
    Type: Number
    MinValue: 1
    MaxValue: 20
    Default: 2
    Description: Number of app replicas. Ignore this parameter if DeployApp=None.
  DeployApp:
    Type: String
    AllowedValues: [ "Sample App", "Own App", None ]
    Default: "Sample App"
    Description: Type of application to deploy. If "Own App", also see the "License" parameters.
  EKSClusterName:
    Type: String
    Description: Name of the new EKS cluster (required).
  LaunchType:
    Type: String
    AllowedValues: [ Fargate, EC2 ]
    Default: Fargate
    Description: Select which launch type to use for your EKS cluster (required).
  LicenseEdition:
    Type: String
    AllowedValues: ["IBM WebSphere Application Server", "IBM WebSphere Application Server Liberty Core", "IBM WebSphere Application Server Network Deployment"]
    Default: "IBM WebSphere Application Server"
    Description:  Product edition.
  LicenseMetric:
    Type: String
    AllowedValues: ["Virtual Processor Core (VPC)", "Processor Value Unit (PVU)"]
    Default: "Virtual Processor Core (VPC)"
    Description: Charge metric code.
  LicenseProductEntitlementSource:
    Type: String
    AllowedValues: ["Standalone", "IBM Cloud Pak for Applications", "IBM WebSphere Server Family Edition", "IBM WebSphere Hybrid Edition"]
    Default: "Standalone"
    Description: Entitlement source for the product.
  LicenseType:
    Type: String
    AllowedValues: [Evaluation, Entitled]
    Default: Entitled
    Description: >-
      If DeployApp=Own App, indicate the type of licese. If "Entitled", you must also select values for
      Edition, Product Entitlement Source and Metric.
  RoleName:
    Type: String
    Description: Customer created role to access EC2, EKS, S3.
    Default: "IBMLibertyDeploymentRole"
  S3BucketNameForLogs:
    Type: String
    Default: ibm-liberty-eks-byol-dev
    Description: AWS S3 Bucket name for logs.
  S3FolderForCode:
    Type: String
    Description: S3 folder for code(Dev only). E.g. s3://ibm-liberty-eks-byol-dev/rk
    Default: s3://ibm-liberty-eks-byol-dev
  S3FolderForCodeHTTPSURL:
    Type: String
    Description: S3 folder HTTPS URL for the cod, without the ending '/' (Dev only).  E.g. https://ibm-liberty-eks-byol-dev.s3.amazonaws.com/rk
    Default: https://ibm-liberty-eks-byol-dev.s3.amazonaws.com

Conditions:
  LicenseAccepted: !Equals
    - !Ref AcceptLicense
    - True
  AppDeployed: !Equals
    - !Ref DeployApp
    - None

Resources:
  IBMLibertyBootNodeStack:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      TemplateURL: !Join [ "" , [!Ref "S3FolderForCodeHTTPSURL", "/templates/ibm-liberty-ec2-bootnode.template.yaml"]]
      Parameters:
        RoleName: !Ref RoleName
  IBMLibertyWorkloadStack:
    Type: 'AWS::CloudFormation::Stack'
    DependsOn:
      - IBMLibertyBootNodeStack
    Properties:
      TemplateURL: !Join [ "" , [!Ref "S3FolderForCodeHTTPSURL", "/templates/ibm-liberty-eks-workload.template.yaml"]]
      Parameters:
        DeployApp: !Ref DeployApp
        BootNodeInstanceId: !GetAtt IBMLibertyBootNodeStack.Outputs.InstanceId
        BootNodeUser: !GetAtt IBMLibertyBootNodeStack.Outputs.User
        EKSClusterName: !Ref EKSClusterName
        LaunchType: !Ref LaunchType
        LicenseEdition: !Ref LicenseEdition
        LicenseMetric: !Ref LicenseMetric
        LicenseProductEntitlementSource: !Ref LicenseProductEntitlementSource
        LicenseType: !Ref LicenseType
        AppNamespace: !Ref AppNamespace
        AppName: !Ref AppName
        AppContainerImageURL: !Ref AppContainerImageURL
        S3FolderForCode: !Ref S3FolderForCode
        S3BucketNameForLogs: !Ref S3BucketNameForLogs
